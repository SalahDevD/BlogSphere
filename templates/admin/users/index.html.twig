{% extends 'base.html.twig' %}

{% block title %}Gestion des utilisateurs - Admin - BlogSphere{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('css/admin.css') }}">
{% endblock %}

{% block body %}
<div class="users-container">
    <div class="container">
        <div class="header">
            <h1>ğŸ‘¥ Gestion des utilisateurs</h1>
            <p style="color: var(--gray-600);">Affichage de <span id="user-count">{{ users|length }}</span> utilisateur(s)</p>
            <a href="{{ path('admin_users_new') }}" style="display: inline-block; margin-top: 1rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg,#543A14,#131010); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; text-decoration: none; transition: all 0.3s;">
                â• Ajouter un utilisateur
            </a>
        </div>

        <div class="search-filters">
            <form id="filter-form" style="display: flex; gap: 1rem; flex: 1; flex-wrap: wrap; align-items: center;">
                <input type="text" id="search-input" name="search" placeholder="Rechercher par nom ou email..." value="{{ search ?? '' }}" style="flex: 1; min-width: 250px;">
                <select id="role-select" name="role" style="padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; font-size: 1rem; cursor: pointer;">
                    <option value="">Tous les rÃ´les</option>
                    <option value="ROLE_USER" {% if (selectedRole ?? '') == 'ROLE_USER' %}selected{% endif %}>ğŸ‘¤ Utilisateur</option>
                    <option value="ROLE_EDITOR" {% if (selectedRole ?? '') == 'ROLE_EDITOR' %}selected{% endif %}>âœï¸ Ã‰diteur</option>
                    <option value="ROLE_SUPERVISOR" {% if (selectedRole ?? '') == 'ROLE_SUPERVISOR' %}selected{% endif %}>ğŸ‘€ Superviseur</option>
                    <option value="ROLE_ADMIN" {% if (selectedRole ?? '') == 'ROLE_ADMIN' %}selected{% endif %}>ğŸ” Administrateur</option>
                </select>
                <button type="submit" style="padding: 0.75rem 1.5rem; background: #543A14; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; white-space: nowrap;">ğŸ” Filtrer</button>
                <button type="button" id="reset-btn" style="padding: 0.75rem 1.5rem; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; text-decoration: none; white-space: nowrap; {% if not search and not selectedRole %}display: none;{% endif %}">âŒ RÃ©initialiser</button>
            </form>
        </div>

        {# Flash Messages #}
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div style="padding: 1rem 1.5rem; background: {{ label == 'error' ? '#fee2e2' : '#d4edda' }}; color: {{ label == 'error' ? '#991b1b' : '#155724' }}; border: 1px solid {{ label == 'error' ? '#f5c6cb' : '#c3e6cb' }}; border-radius: 8px; margin-bottom: 1.5rem;">
                    {{ message }}
                </div>
            {% endfor %}
        {% endfor %}

        <div id="users-table">
            {% include 'admin/users/table.html.twig' %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filter-form');
    const searchInput = document.getElementById('search-input');
    const roleSelect = document.getElementById('role-select');
    const resetBtn = document.getElementById('reset-btn');
    const usersTable = document.getElementById('users-table');
    const userCountSpan = document.getElementById('user-count');

    // Debounce function for search input
    let debounceTimer;
    function debounceSearch() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(applyFilters, 300);
    }

    // Apply filters
    function applyFilters(e) {
        if (e) {
            e.preventDefault();
        }

        const search = searchInput.value.trim();
        const role = roleSelect.value.trim();

        // Build the URL for the filter endpoint
        const url = new URL('{{ path("admin_users_filter") }}', window.location.origin);
        if (search) url.searchParams.append('search', search);
        if (role) url.searchParams.append('role', role);

        // Show/hide reset button
        if (search || role) {
            resetBtn.style.display = 'inline-block';
        } else {
            resetBtn.style.display = 'none';
        }

        console.log('Fetching:', url.toString());

        // Send AJAX request
        fetch(url.toString(), {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error('HTTP error, status = ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Data received:', data);
            if (data.success && data.html) {
                usersTable.innerHTML = data.html;
                userCountSpan.textContent = data.count;
            } else if (!data.success) {
                console.error('Server error:', data.error);
                alert('Erreur serveur: ' + data.error);
            } else {
                console.error('Invalid response format:', data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors du filtrage: ' + error.message);
        });
    }

    // Reset filters
    resetBtn.addEventListener('click', function(e) {
        e.preventDefault();
        searchInput.value = '';
        roleSelect.value = '';
        applyFilters();
    });

    // Listen to filter form submission
    filterForm.addEventListener('submit', applyFilters);
});
</script>

{% endblock %}
