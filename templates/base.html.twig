<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}BlogSphere{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800;900&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ asset('css/base.css') }}">
    {% block stylesheets %}{% endblock %}
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="{{ path('app_home') }}" class="logo">BlogSphere</a>
            
            <div class="nav-links">
                {% if is_granted('IS_AUTHENTICATED_FULLY') %}
                    {% if not is_granted('ROLE_ADMIN') and not is_granted('ROLE_SUPERVISOR') %}
                        <a href="{{ path('app_article_index') }}">Articles</a>
                        <a href="{{ path('app_about') }}">√Ä Propos</a>
                        <a href="{{ path('app_contact_support') }}">Support</a>
                        {% if is_granted('ROLE_EDITOR') %}
                            <a href="{{ path('app_article_new') }}">Cr√©er</a>
                        {% endif %}
                    {% else %}
                        <a href="{{ path('app_article_index') }}">Articles</a>
                    {% endif %}

                    {% if is_granted('ROLE_ADMIN') %}
                        <a href="{{ path('admin_dashboard') }}">Admin</a>
                    {% endif %}

                    {% if is_granted('ROLE_SUPERVISOR') %}
                        <a href="{{ path('supervisor_moderation_dashboard') }}">Supervision</a>
                    {% endif %}
                {% else %}
                    <a href="{{ path('app_article_index') }}">Articles</a>
                    <a href="{{ path('app_about') }}">√Ä Propos</a>
                {% endif %}
            </div>

            <div class="nav-right">
                <form class="search-form" method="GET" action="{{ path('app_article_index') }}">
                    <button type="submit" title="Rechercher les articles">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </button>
                    <input type="text" name="search" placeholder="Rechercher des articles...">
                </form>

                {% if is_granted('IS_AUTHENTICATED_FULLY') %}
                    <div class="profile-dropdown">
                        <div class="profile-avatar">
                            {% set profileImage = app.user.images|filter(img => img.isProfile)|first %}
                            {% if profileImage %}
                                <img src="{{ asset('uploads/profile/' ~ profileImage.filename) }}" alt="Profile">
                            {% else %}
                                {{ app.user.name|first }}
                            {% endif %}
                        </div>
                        <div class="dropdown-menu">
                            <div class="dropdown-header">
                                <div class="dropdown-user-name">{{ app.user.name }}</div>
                                <div class="dropdown-user-email">{{ app.user.email }}</div>
                            </div>
                            <div class="dropdown-items">
                                <a href="{{ path('user_profile_index') }}" class="dropdown-item">üë§ Mon Profil</a>
                                <a href="{{ path('user_profile_edit') }}" class="dropdown-item">‚öôÔ∏è Param√®tres</a>
                                {% if is_granted('ROLE_ADMIN') or is_granted('ROLE_SUPERVISOR') %}
                                    <div class="dropdown-divider"></div>
                                    {% if is_granted('ROLE_ADMIN') %}
                                        <a href="{{ path('admin_messages_index') }}" class="dropdown-item">üì® Messages</a>
                                    {% else %}
                                        <a href="{{ path('supervisor_messages') }}" class="dropdown-item">üì® Messages</a>
                                    {% endif %}
                                {% endif %}
                                <div class="dropdown-divider"></div>
                                <a href="{{ path('app_logout') }}" class="dropdown-item danger">üö™ D√©connexion</a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <a href="{{ path('app_login') }}" class="btn btn-outline">Connexion</a>
                    <a href="{{ path('app_register') }}" class="btn">Inscription</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="alerts">
        {% for message in app.flashes('success') %}
            <div class="alert alert-success">‚úì {{ message }}</div>
        {% endfor %}
        {% for message in app.flashes('error') %}
            <div class="alert alert-error">‚úó {{ message }}</div>
        {% endfor %}
        {% for message in app.flashes('info') %}
            <div class="alert alert-info">‚Ñπ {{ message }}</div>
        {% endfor %}
        {% for message in app.flashes('warning') %}
            <div class="alert alert-warning">‚ö† {{ message }}</div>
        {% endfor %}
    </div>

    <main>
        {% block body %}{% endblock %}
    </main>

    {% if app.user and not is_granted('ROLE_ADMIN') and not is_granted('ROLE_SUPERVISOR') %}
        <button class="support-chat-button" onclick="toggleSupportChat()" title="Contacter le support">
            üí¨
        </button>

        <div class="support-chat-popup" id="supportChatPopup">
            <div class="chat-popup-header">
                <div class="chat-popup-title">üí¨ Support</div>
                <button class="chat-popup-close" onclick="toggleSupportChat()" type="button">√ó</button>
            </div>

            <div class="chat-popup-messages" id="chatMessages">
                <div class="chat-message chat-message-received">
                    <div class="chat-message-bubble">
                        üëã Bonjour {{ app.user.name }} ! Comment puis-je vous aider aujourd'hui ?
                    </div>
                </div>
            </div>

            <div class="chat-popup-input">
                <form onsubmit="sendSupportMessage(event)">
                    <input type="text" id="chatInput" placeholder="Votre message..." required>
                    <button type="submit" title="Envoyer">üì§</button>
                </form>
            </div>
        </div>
    {% endif %}

    <footer>
        <div class="container">
            <div>
                <h3>BlogSphere</h3>
                <p>Une plateforme de blog moderne et collaborative pour partager vos id√©es avec le monde.</p>
            </div>
            <div>
                <h3>Liens rapides</h3>
                <ul>
                    <li><a href="{{ path('app_home') }}">‚Ä¢ Accueil</a></li>
                    <li><a href="{{ path('app_article_index') }}">‚Ä¢ Articles</a></li>
                    {% if app.user %}
                        <li><a href="{{ path('user_profile_index') }}">‚Ä¢ Mon Profil</a></li>
                    {% endif %}
                </ul>
            </div>
            <div>
                <h3>Nous contacter</h3>
                <ul>
                    <li><a href="mailto:support@blogsphere.com">‚Ä¢ Email: support@blogsphere.com</a></li>
                    <li>‚Ä¢ T√©l√©phone: +212 5XX XXX XXX</li>
                </ul>
            </div>
            <div>
                <h3>√Ä propos</h3>
                <ul>
                    <li><a href="#">‚Ä¢ Conditions d'utilisation</a></li>
                    <li><a href="#">‚Ä¢ Politique de confidentialit√©</a></li>
                    <li><a href="#">‚Ä¢ Nous rejoindre</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <script>
        document.querySelectorAll('.alert').forEach(alert => {
            setTimeout(() => {
                alert.style.animation = 'slideOutRight 0.5s ease';
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        });

        function toggleSupportChat() {
            const popup = document.getElementById('supportChatPopup');
            if (popup) {
                popup.classList.toggle('active');
                if (popup.classList.contains('active')) {
                    loadSupportMessages();
                    if (!window.supportChatInterval) {
                        window.supportChatInterval = setInterval(loadSupportMessages, 2000);
                    }
                    const input = document.getElementById('chatInput');
                    if (input) input.focus();
                } else {
                    if (window.supportChatInterval) {
                        clearInterval(window.supportChatInterval);
                        window.supportChatInterval = null;
                    }
                }
            }
        }

        function loadSupportMessages() {
            fetch('/api/chat/messages')
                .then(response => response.json())
                .then(messages => {
                    const container = document.getElementById('chatMessages');
                    const existingMessages = Array.from(container.querySelectorAll('[data-message-id]'));
                    const existingIds = new Set(existingMessages.map(el => el.getAttribute('data-message-id')));
                    
                    messages.forEach((message, index) => {
                        const messageId = `msg-${message.id || index}`;
                        
                        // Only add new messages
                        if (!existingIds.has(messageId)) {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = message.isFromUser ? 'chat-message chat-message-sent' : 'chat-message chat-message-received';
                            messageDiv.setAttribute('data-message-id', messageId);
                            
                            let imageHtml = '';
                            if (message.image) {
                                imageHtml = `<img src="/uploads/support/${message.image}" alt="Image" style="max-width: 200px; border-radius: 12px; margin-bottom: 0.5rem;">`;
                            }
                            
                            messageDiv.innerHTML = `
                                <div class="chat-message-bubble">
                                    ${imageHtml}
                                    <div>${escapeHtml(message.content)}</div>
                                    <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.5rem;">${message.createdAtTime}</div>
                                </div>
                            `;
                            
                            container.appendChild(messageDiv);
                        }
                    });
                    
                    container.scrollTop = container.scrollHeight;
                })
                .catch(error => console.error('Error loading messages:', error));
        }

        function sendSupportMessage(event) {
            event.preventDefault();
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                fetch('/api/chat/message/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ content: message })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success || data.id) {
                        input.value = '';
                        loadSupportMessages();
                    } else {
                        alert('Erreur lors de l\'envoi du message: ' + (data.error || 'Erreur inconnue'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erreur lors de l\'envoi du message');
                });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>

    {% block javascripts %}{% endblock %}
</body>
</html>
