{% extends 'base.html.twig' %}

{% block title %}{{ article.title }}{% endblock %}

{% block body %}
<div style="background: #f9fafb; min-height: 100vh; padding: 3rem 0;">
    <div style="max-width: 900px; margin: 0 auto; padding: 0 2rem;">
        <a href="{{ path('app_article_index') }}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: #e5e7eb; color: #374151; text-decoration: none; border-radius: 8px; font-weight: 600; margin-bottom: 2rem; transition: all 0.3s;">‚Üê Tous les articles</a>

        {# Flash messages #}
        {% for message in app.flashes('success') %}
            <div style="background: #d1fae5; padding: 1rem; border-radius: 8px; border-left: 4px solid #10b981; color: #065f46; margin-bottom: 1.5rem; font-weight: 600;">
                {{ message }}
            </div>
        {% endfor %}
        {% for message in app.flashes('error') %}
            <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; border-left: 4px solid #ef4444; color: #991b1b; margin-bottom: 1.5rem; font-weight: 600;">
                {{ message }}
            </div>
        {% endfor %}

        <div style="background: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            {% if article.category %}
                <span style="display: inline-block; padding: 0.35rem 0.85rem; background: #FFE5DC; color: #FF6B35; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-bottom: 1rem;">{{ article.category.name }}</span>
            {% endif %}

            <h1 style="font-size: 2.5rem; font-weight: 900; color: #111827; margin-bottom: 1.5rem; line-height: 1.3;">{{ article.title }}</h1>

            <div style="display: flex; gap: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb; margin-bottom: 1rem; flex-wrap: wrap;">
                <div>
                    <p style="font-size: 0.85rem; color: #6b5563; font-weight: 600; text-transform: uppercase;">AUTEUR</p>
                    <p style="font-size: 1rem; color: #111827; font-weight: 600;">{{ article.author.name }}</p>
                </div>
                <div>
                    <p style="font-size: 0.85rem; color: #6b5563; font-weight: 600; text-transform: uppercase;">DATE</p>
                    <p style="font-size: 1rem; color: #111827; font-weight: 600;">{{ article.createdAt|date('d M Y H:i') }}</p>
                </div>
            </div>

            {% if is_granted('ROLE_USER') and article.author == app.user %}
                <div style="display: flex; gap: 1rem;">
                    <a href="{{ path('app_article_edit', {id: article.id}) }}" style="padding: 0.5rem 1rem; background: #667eea; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">‚úèÔ∏è Modifier</a>
                    <form method="POST" action="{{ path('app_article_delete', {id: article.id}) }}" style="display: inline; margin: 0;">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ article.id) }}">
                        <button type="submit" onclick="return confirm('Supprimer ?')" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">üóëÔ∏è Supprimer</button>
                    </form>
                </div>
            {% endif %}
        </div>

        {% if article.image %}
            <img src="{{ asset('uploads/articles/' ~ article.image) }}" alt="{{ article.title }}" style="width: 100%; max-height: 500px; object-fit: cover; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);" onerror="this.style.display='none';">
        {% endif %}

        <div style="background: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; font-size: 1.1rem; color: #374151; line-height: 1.8; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            {{ article.content|nl2br|raw }}
        </div>

        {# ============= SECTION R√âACTIONS ============= #}
        <div style="background: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #111827;">Votre avis</h3>
                
                {% if is_granted('ROLE_USER') and article.author != app.user %}
                    <button id="reportBtn" class="btn-report" style="padding: 0.5rem 1rem; background: #f97316; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">üö© Signaler</button>
                {% endif %}
            </div>
            
            {% if is_granted('ROLE_USER') %}
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                    {# üëç Bouton Like #}
                    <form method="POST"
                          action="{{ path('app_reaction_article_like', { articleId: article.id }) }}"
                          style="display: inline;">
                        <button type="submit"
                                style="
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.3s;
                                    font-size: 1rem;
                                    {% if userReaction and userReaction.isLike %}
                                        background: #10b981;
                                        border: 2px solid #10b981;
                                        color: white;
                                    {% else %}
                                        background: white;
                                        border: 2px solid #e5e7eb;
                                        color: #374151;
                                    {% endif %}
                                ">
                            üëç J'aime
                            <span style="
                                margin-left: 0.5rem;
                                padding: 0.25rem 0.5rem;
                                border-radius: 4px;
                                background: rgba(0,0,0,0.1);
                                font-size: 0.9rem;
                            ">
                                {{ likesCount }}
                            </span>
                        </button>
                    </form>

                    {# üëé Bouton Dislike #}
                    <form method="POST"
                          action="{{ path('app_reaction_article_dislike', { articleId: article.id }) }}"
                          style="display: inline;">
                        <button type="submit"
                                style="
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    transition: all 0.3s;
                                    font-size: 1rem;
                                    {% if userReaction and not userReaction.isLike %}
                                        background: #ef4444;
                                        border: 2px solid #ef4444;
                                        color: white;
                                    {% else %}
                                        background: white;
                                        border: 2px solid #e5e7eb;
                                        color: #374151;
                                    {% endif %}
                                ">
                            üëé Je n'aime pas
                            <span style="
                                margin-left: 0.5rem;
                                padding: 0.25rem 0.5rem;
                                border-radius: 4px;
                                background: rgba(0,0,0,0.1);
                                font-size: 0.9rem;
                            ">
                                {{ dislikesCount }}
                            </span>
                        </button>
                    </form>
                </div>
            {% else %}
                <p style="background: #FFE5DC; padding: 1rem; border-radius: 8px; border-left: 4px solid #FF6B35; color: #111827;">
                    üë§ <a href="{{ path('app_login') }}" style="color: #FF6B35; font-weight: 600; text-decoration: none;">Connectez-vous</a> pour r√©agir
                </p>
                <p style="margin-top: 1rem; color: #6b5563; font-size: 0.95rem;">
                    üëç <strong>{{ likesCount }}</strong> likes ¬∑ üëé <strong>{{ dislikesCount }}</strong> dislikes
                </p>
            {% endif %}
        </div>

        {# ============= SECTION COMMENTAIRES ============= #}
        <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <h3 style="font-size: 1.25rem; font-weight: 700; color: #111827; margin-bottom: 1.5rem;">üí¨ Commentaires ({{ article.comments|length }})</h3>
            
            {% if is_granted('ROLE_USER') %}
                <form method="POST" action="{{ path('app_comment_add', {id: article.id}) }}" style="margin-bottom: 2rem;">
                    <textarea name="content" style="width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; min-height: 120px; margin-bottom: 1rem; font-family: inherit; font-size: 1rem;" placeholder="Votre commentaire..." required></textarea>
                    <button type="submit" style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #FF6B35, #E85A2A); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: all 0.3s;">Publier</button>
                </form>
            {% endif %}

            {% if article.comments|length > 0 %}
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% for comment in article.comments %}
                    {% if comment.status == 'approved' %}
                        <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #FF6B35;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                <div>
                                    <strong style="color: #111827; display: block; margin-bottom: 0.5rem; font-size: 1rem;">{{ comment.author.name }}</strong>
                                    <small style="color: #6b5563; display: block; margin-bottom: 1rem; font-size: 0.85rem;">{{ comment.createdAt|date('d M Y H:i') }}</small>
                                </div>
                                {% if is_granted('ROLE_USER') and comment.author != app.user %}
                                    <button type="button" class="btn-report-comment" data-comment-id="{{ comment.id }}" style="padding: 0.4rem 0.8rem; background: #f97316; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8rem; white-space: nowrap;">üö© Signaler</button>
                                {% endif %}
                            </div>
                            <p style="color: #374151; line-height: 1.6; margin: 0;">{{ comment.content|nl2br }}</p>
                        </div>
                    {% endif %}
                {% endfor %}
                </div>
            {% else %}
                <p style="text-align: center; color: #6b5563; padding: 2rem;">Aucun commentaire. Soyez le premier !</p>
            {% endif %}
        </div>
    </div>
</div>

{# Modal de signalement #}
<div id="reportModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; margin: auto; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <h2 style="font-size: 1.5rem; font-weight: 700; color: #111827; margin-bottom: 1rem;">Signaler ce contenu</h2>
        <p style="color: #6b5563; margin-bottom: 1.5rem;">Aidez-nous √† am√©liorer la communaut√© en signalant un contenu inappropri√©.</p>
        
        <form id="reportForm" style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
                <label for="reportReason" style="display: block; font-weight: 600; color: #111827; margin-bottom: 0.5rem;">Raison du signalement *</label>
                <select id="reportReason" name="reason" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; font-size: 1rem;" required>
                    <option value="">S√©lectionnez une raison</option>
                    <option value="spam">Spam</option>
                    <option value="inappropriate">Contenu inappropri√©</option>
                    <option value="harassment">Harc√®lement</option>
                    <option value="misinformation">D√©sinformation</option>
                    <option value="copyright">Violation de droits d'auteur</option>
                    <option value="other">Autre</option>
                </select>
            </div>
            
            <div>
                <label for="reportDescription" style="display: block; font-weight: 600; color: #111827; margin-bottom: 0.5rem;">Description (optionnel)</label>
                <textarea id="reportDescription" name="description" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; font-size: 1rem; min-height: 100px;" placeholder="Expliquez pourquoi vous signalez ce contenu..."></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="button" onclick="closeReportModal()" style="flex: 1; padding: 0.75rem 1.5rem; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Annuler</button>
                <button type="submit" style="flex: 1; padding: 0.75rem 1.5rem; background: #f97316; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Signaler</button>
            </div>
        </form>
    </div>
</div>

<script>
    let reportType = null;
    let reportId = null;

    // Bouton de signalement article
    const reportBtn = document.getElementById('reportBtn');
    if (reportBtn) {
        reportBtn.addEventListener('click', (e) => {
            e.preventDefault();
            reportType = 'article';
            reportId = {{ article.id }};
            console.log('Article report button clicked:', reportType, reportId);
            openReportModal();
        });
    }

    // Utiliser la d√©l√©gation d'√©v√©nements pour les boutons de signalement commentaires
    document.addEventListener('click', (e) => {
        const reportBtn = e.target.closest('.btn-report-comment');
        if (reportBtn) {
            e.preventDefault();
            e.stopPropagation();
            reportType = 'comment';
            reportId = reportBtn.getAttribute('data-comment-id');
            console.log('Comment report button clicked:', reportType, reportId, 'Button:', reportBtn);
            openReportModal();
        }
    });

    function openReportModal() {
        const modal = document.getElementById('reportModal');
        if (modal) {
            modal.style.display = 'flex';
            console.log('Modal opened with reportType:', reportType, 'reportId:', reportId);
        }
    }

    function closeReportModal() {
        const modal = document.getElementById('reportModal');
        if (modal) {
            modal.style.display = 'none';
        }
        document.getElementById('reportForm').reset();
    }

    // Fermer le modal en cliquant en dehors
    const reportModal = document.getElementById('reportModal');
    if (reportModal) {
        reportModal.addEventListener('click', (e) => {
            if (e.target.id === 'reportModal') {
                closeReportModal();
            }
        });
    }

    // Soumettre le signalement
    const reportForm = document.getElementById('reportForm');
    if (reportForm) {
        reportForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const reason = document.getElementById('reportReason').value;
            const description = document.getElementById('reportDescription').value;

            console.log('Form submitted - reportType:', reportType, 'reportId:', reportId);

            if (!reason) {
                alert('Veuillez s√©lectionner une raison');
                return;
            }

            if (!reportType || !reportId) {
                alert('Erreur: Type de signalement ou ID manquant');
                console.error('Missing reportType or reportId:', reportType, reportId);
                return;
            }

            try {
                let endpoint;
                if (reportType === 'article') {
                    endpoint = `/api/reports/article/{{ article.id }}`;
                } else if (reportType === 'comment') {
                    endpoint = `/api/reports/comment/${reportId}`;
                } else {
                    throw new Error('Invalid report type: ' + reportType);
                }

                console.log('Sending report to:', endpoint);

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        reason: reason,
                        description: description
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('‚úÖ Signalement envoy√© avec succ√®s. Merci de votre contribution !');
                    closeReportModal();
                } else {
                    alert('‚ùå ' + (data.error || 'Erreur lors du signalement'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Erreur lors de l\'envoi du signalement: ' + error.message);
            }
        });
    }
</script>

{% endblock %}