{% extends 'base.html.twig' %}

{% block title %}Conversation - BlogSphere{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ asset('css/contact.css') }}">
{% endblock %}

{% block body %}
<div class="conversation-container">
    <div class="conversation-header">
        <div>
            <h1>{{ mainMessage.subject }}</h1>
        </div>
        <a href="{{ path('app_contact_support') }}" class="back-link">‚Üê Retour aux conversations</a>
    </div>

    {% for message in app.flashes('success') %}
        <div class="alert alert-success">
            {{ message }}
        </div>
    {% endfor %}

    {% for message in app.flashes('error') %}
        <div class="alert alert-error">
            {{ message }}
        </div>
    {% endfor %}

    <div class="message-info">
        <p>
            <strong>Type:</strong>
            {% if mainMessage.messageType == 'question' %}
                ‚ùì Question
            {% elseif mainMessage.messageType == 'problem' %}
                ‚ö†Ô∏è Probl√®me
            {% else %}
                üìå Autre
            {% endif %}
            | <strong>Cr√©√© le:</strong> {{ mainMessage.createdAt|date('d/m/Y √† H:i') }}
        </p>
    </div>

    <div class="message-thread">
        {% for msg in conversationMessages %}
            <div class="message {% if msg.sender == app.user and msg.receiver == null %}from-user{% else %}from-support{% endif %}">
                <div class="message-avatar">
                    {{ (msg.sender.firstName[0] ?? msg.sender.name[0] ?? '?')|upper }}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <div class="message-sender">
                            {{ msg.sender.firstName }} {{ msg.sender.lastName }}
                            {% if 'ROLE_ADMIN' in msg.sender.roles %}
                                <span style="background: #ef4444; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">ADMIN</span>
                            {% elseif 'ROLE_SUPERVISOR' in msg.sender.roles %}
                                <span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin-left: 0.5rem;">SUPERVISOR</span>
                            {% endif %}
                        </div>
                        <div class="message-time">{{ msg.createdAt|date('d/m/Y H:i') }}</div>
                    </div>
                    <div class="message-text">{{ msg.content }}</div>
                </div>
            </div>
        {% endfor %}
    </div>

    {% if 'ROLE_ADMIN' in app.user.roles or 'ROLE_SUPERVISOR' in app.user.roles %}
        <div class="reply-section">
            <h3>R√©pondre √† cette conversation</h3>
            <form method="POST" action="{{ path('app_contact_support_reply', {id: mainMessage.id}) }}">
                <div class="form-group">
                    <label for="reply">Votre R√©ponse *</label>
                    <textarea id="reply" name="reply" placeholder="R√©pondez √† l'utilisateur..." required></textarea>
                </div>
                <button type="submit" class="btn">Envoyer la R√©ponse</button>
            </form>
        </div>
    {% else %}
        {% if mainMessage.sender == app.user %}
            <div class="message-info">
                <p>
                    üí° Un superviseur ou administrateur r√©pondra bient√¥t √† votre message.
                </p>
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}
